<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>API Tester - BattleStats</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    select, input, textarea, button { width: 100%; padding: 8px; margin-top: 5px; }
    textarea { height: 120px; resize: vertical; }
    pre { background: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; }
    .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 10px 0; }
    .api-section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
    .client-api { border-color: #28a745; }
    .server-api { border-color: #dc3545; }
    .hidden { display: none; }
    button { background: #007bff; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <h1>API Tester - BattleStats</h1>
  
  <label>
    –¢–∏–ø API:
    <select id="apiType" onchange="switchApiType()">
      <option value="client">Client API (/api/battle-stats) - –ó –±—Ä–∞—É–∑–µ—Ä–∞</option>
      <option value="server">Server API (/api/server) - –¢—ñ–ª—å–∫–∏ —Å–µ—Ä–≤–µ—Ä-–¥–æ-—Å–µ—Ä–≤–µ—Ä</option>
    </select>
  </label>

  <!-- Warning for Server API -->
  <div id="serverWarning" class="warning hidden">
    ‚ö†Ô∏è <strong>–£–≤–∞–≥–∞:</strong> Server API –Ω–µ –ø—Ä–∞—Ü—é—î –∑ –±—Ä–∞—É–∑–µ—Ä–∞ —á–µ—Ä–µ–∑ CORS! 
    –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ Postman, curl –∞–±–æ Node.js –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è.
  </div>

  <div id="clientSection" class="api-section client-api">
    <h3>üåê Client API - /api/battle-stats</h3>
    <p>–ë–µ–∑–ø–µ–∫–∞: CORS + X-API-Key</p>
    
    <label>
      Endpoint:
      <select id="clientEndpoint">
        <option value="health">GET /health (–±–µ–∑ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó)</option>
        <option value="version">GET /version (–±–µ–∑ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó)</option>
        <option value="stats">GET /stats</option>
        <option value="other-players">GET /other-players</option>
        <option value="update-stats">POST /update-stats</option>
        <option value="import">POST /import</option>
        <option value="clear">DELETE /clear</option>
        <option value="battle/123">DELETE /battle/:battleId</option>
        <option value="clear-database">DELETE /clear-database (–ø–æ—Ç—Ä—ñ–±–µ–Ω X-Secret-Key!)</option>
      </select>
    </label>
  </div>

  <div id="serverSection" class="api-section server-api hidden">
    <h3>üñ•Ô∏è Server API - /api/server</h3>
    <p>–ë–µ–∑–ø–µ–∫–∞: X-Secret-Key + X-API-Key (–±–µ–∑ CORS)</p>
    
    <label>
      Endpoint:
      <select id="serverEndpoint">
        <option value="health">GET /health (–±–µ–∑ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó)</option>
        <option value="version">GET /version (–±–µ–∑ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó)</option>
        <option value="stats">GET /stats</option>
        <option value="other-players">GET /other-players</option>
        <option value="update-stats">POST /update-stats</option>
        <option value="import">POST /import</option>
        <option value="clear">DELETE /clear</option>
        <option value="battle/456">DELETE /battle/:battleId</option>
        <option value="clear-database">DELETE /clear-database</option>
      </select>
    </label>
  </div>

  <label>
    –ú–µ—Ç–æ–¥ (–∞–≤—Ç–æ-–≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è):
    <select id="method">
      <option value="GET">GET</option>
      <option value="POST">POST</option>
      <option value="DELETE">DELETE</option>
    </select>
  </label>

  <label>
    X-API-Key:
    <input type="text" id="apiKey" value="test" />
  </label>

  <label id="secretKeyLabel">
    X-Secret-Key:
    <input type="password" id="secretKey" placeholder="–í–≤–µ–¥—ñ—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω–∏–π –∫–ª—é—á" />
  </label>

  <label>
    X-Player-ID (–¥–ª—è –¥–µ—è–∫–∏—Ö endpoints):
    <input type="text" id="playerId" placeholder="player123" />
  </label>
  
  <label>
    –¢—ñ–ª–æ –∑–∞–ø–∏—Ç—É (JSON):
    <textarea id="body" placeholder='–ü—Ä–∏–∫–ª–∞–¥ –¥–ª—è update-stats:
{
  "BattleStats": {
    "arena123": {
      "startTime": 1693123456000,
      "duration": 300,
      "win": 1,
      "mapName": "Test Map",
      "players": {
        "player123": {
          "name": "TestPlayer",
          "damage": 1500,
          "kills": 3,
          "points": 2000,
          "vehicle": "Tank T-34"
        }
      }
    }
  },
  "PlayerInfo": {
    "player123": "TestPlayer"
  }
}'>{}</textarea>
  </label>
  
  <button id="send" onclick="sendRequest()">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ó–∞–ø–∏—Ç</button>
  
  <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h2>
  <div>
    <strong>URL:</strong> <span id="requestUrl">-</span><br>
    <strong>Status:</strong> <span id="responseStatus">-</span><br>
    <strong>Headers:</strong> <span id="responseHeaders">-</span>
  </div>
  <pre id="output">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ó–∞–ø–∏—Ç" –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è API</pre>
  
  <script>
    const BASE_URL = "https://node-websocket-758468a49fee.herokuapp.com";
    
    function switchApiType() {
      const apiType = document.getElementById("apiType").value;
      const clientSection = document.getElementById("clientSection");
      const serverSection = document.getElementById("serverSection");
      const serverWarning = document.getElementById("serverWarning");
      
      if (apiType === "client") {
        clientSection.classList.remove("hidden");
        serverSection.classList.add("hidden");
        serverWarning.classList.add("hidden");
        updateMethodFromEndpoint();
      } else {
        clientSection.classList.add("hidden");
        serverSection.classList.remove("hidden");
        serverWarning.classList.remove("hidden");
        updateMethodFromEndpoint();
      }
    }
    
    function updateMethodFromEndpoint() {
      const apiType = document.getElementById("apiType").value;
      const endpoint = apiType === "client" 
        ? document.getElementById("clientEndpoint").value 
        : document.getElementById("serverEndpoint").value;
      
      const methodSelect = document.getElementById("method");
      
      if (endpoint.includes("update-stats") || endpoint.includes("import")) {
        methodSelect.value = "POST";
      } else if (endpoint.includes("clear") || endpoint.includes("battle/")) {
        methodSelect.value = "DELETE";  
      } else {
        methodSelect.value = "GET";
      }
    }
    
    // Auto-update method when endpoint changes
    document.getElementById("clientEndpoint").addEventListener("change", updateMethodFromEndpoint);
    document.getElementById("serverEndpoint").addEventListener("change", updateMethodFromEndpoint);
    
    async function sendRequest() {
      const apiType = document.getElementById("apiType").value;
      const method = document.getElementById("method").value;
      const endpoint = apiType === "client" 
        ? document.getElementById("clientEndpoint").value 
        : document.getElementById("serverEndpoint").value;
      const apiKey = document.getElementById("apiKey").value;
      const secretKey = document.getElementById("secretKey").value;
      const playerId = document.getElementById("playerId").value;
      const body = document.getElementById("body").value;
      
      const output = document.getElementById("output");
      const requestUrl = document.getElementById("requestUrl");
      const responseStatus = document.getElementById("responseStatus");
      const responseHeaders = document.getElementById("responseHeaders");
      
      // Build URL
      const baseApiPath = apiType === "client" ? "/api/battle-stats" : "/api/server";
      const fullUrl = `${BASE_URL}${baseApiPath}/${endpoint}`;
      
      requestUrl.textContent = fullUrl;
      output.textContent = "üîÑ –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∑–∞–ø–∏—Ç...";
      responseStatus.textContent = "–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...";
      responseHeaders.textContent = "-";
      
      try {
        // Build headers
        const headers = {
          "Content-Type": "application/json",
        };
        
        if (apiKey) {
          headers["X-API-Key"] = apiKey;
        }
        
        if (secretKey && (apiType === "server" || endpoint === "clear-database")) {
          headers["X-Secret-Key"] = secretKey;
        }
        
        if (playerId) {
          headers["X-Player-ID"] = playerId;
        }
        
        const options = { method, headers };
        
        if (method !== "GET" && body.trim() !== "") {
          try {
            JSON.parse(body);
            options.body = body;
          } catch (e) {
            output.textContent = `‚ùå –ù–µ–≤–∞–ª—ñ–¥–Ω–∏–π JSON: ${e.message}`;
            return;
          }
        }
        
        const response = await fetch(fullUrl, options);
        const responseText = await response.text();
        
        responseStatus.textContent = `${response.status} ${response.statusText}`;
        const headersList = Array.from(response.headers.entries())
          .map(([key, value]) => `${key}: ${value}`)
          .join(', ');
        responseHeaders.textContent = headersList || "–ù–µ–º–∞—î –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤";
        
        try {
          const jsonResponse = JSON.parse(responseText);
          output.textContent = JSON.stringify(jsonResponse, null, 2);
        } catch {
          output.textContent = responseText;
        }
        
        if (response.ok) {
          output.style.border = "3px solid #28a745";
        } else {
          output.style.border = "3px solid #dc3545";
        }
        
      } catch (err) {
        output.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É: ${err.message}`;
        output.style.border = "3px solid #dc3545";
        responseStatus.textContent = "–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ";
        
        if (err.message.includes("fetch")) {
          output.textContent += `\n\nüí° –ü—ñ–¥–∫–∞–∑–∫–∞: –Ø–∫—â–æ —Ü–µ CORS –ø–æ–º–∏–ª–∫–∞ –¥–ª—è /api/server, —Ü–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - —Ü–µ–π API –Ω–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞!`;
        }
      }
    }
    
    switchApiType();
  </script>
</body>
</html>
