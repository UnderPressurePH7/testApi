<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>API Tester - BattleStats</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f8f9fa; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 30px; }
    .section { background: white; border-radius: 8px; padding: 20px; margin: 15px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    label { display: block; margin: 10px 0 5px 0; font-weight: bold; }
    select, input, textarea, button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    textarea { height: 150px; resize: vertical; font-family: monospace; }
    button { background: #007bff; color: white; border: none; cursor: pointer; font-size: 16px; }
    button:hover { background: #0056b3; }
    button:disabled { background: #6c757d; cursor: not-allowed; }
    .output { background: #f8f9fa; padding: 15px; border-radius: 4px; border: 2px solid #e9ecef; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
    .success { border-color: #28a745; background: #d4edda; }
    .error { border-color: #dc3545; background: #f8d7da; }
    .info { background: #d1ecf1; border: 1px solid #bee5eb; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .tabs { display: flex; margin-bottom: 20px; }
    .tab { padding: 12px 24px; background: #e9ecef; border: none; cursor: pointer; margin-right: 5px; border-radius: 4px 4px 0 0; }
    .tab.active { background: #007bff; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0; }
    .quick-btn { padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .quick-btn:hover { background: #545b62; }
    .data-display { background: white; padding: 15px; border-radius: 4px; margin: 10px 0; }
    .player-list, .battle-list { max-height: 300px; overflow-y: auto; }
    .item { padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 4px; border-left: 4px solid #007bff; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéÆ BattleStats API Tester</h1>
      <p>–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è API –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–æ—ó–≤ World of Tanks</p>
    </div>

    <div class="section">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('request')">üì° –ó–∞–ø–∏—Ç–∏</button>
        <button class="tab" onclick="switchTab('data')">üìä –ü–µ—Ä–µ–≥–ª—è–¥ –¥–∞–Ω–∏—Ö</button>
        <button class="tab" onclick="switchTab('send')">üì§ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–∏—Ö</button>
      </div>

      <div id="requestTab" class="tab-content active">
        <h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É</h3>
        
        <label>API Key:</label>
        <input type="text" id="apiKey" value="test" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à API –∫–ª—é—á">
        
        <label>Player ID (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ):</label>
        <input type="text" id="playerId" placeholder="123456789" value="123456789">

        <div class="quick-actions">
          <button class="quick-btn" onclick="quickRequest('health')">üü¢ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</button>
          <button class="quick-btn" onclick="quickRequest('stats')">üìä –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ</button>
          <button class="quick-btn" onclick="quickRequest('stats-paginated')">üìÑ –û—Ç—Ä–∏–º–∞—Ç–∏ –∑ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—î—é</button>
          <button class="quick-btn" onclick="quickRequest('other-players')">üë• –î–∞–Ω—ñ —ñ–Ω—à–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤</button>
        </div>

        <label>–í–ª–∞—Å–Ω–∏–π –∑–∞–ø–∏—Ç:</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
          <select id="method">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="DELETE">DELETE</option>
          </select>
          <input type="text" id="endpoint" placeholder="/stats" value="/stats">
          <button onclick="sendCustomRequest()">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
        </div>
      </div>

      <div id="dataTab" class="tab-content">
        <h3>–ü–µ—Ä–µ–≥–ª—è–¥ –¥–∞–Ω–∏—Ö</h3>
        
        <div class="quick-actions">
          <button class="quick-btn" onclick="loadAllData()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ</button>
          <button class="quick-btn" onclick="loadPlayerInfo()">üë§ –ì—Ä–∞–≤—Ü—ñ</button>
          <button class="quick-btn" onclick="loadBattles()">‚öîÔ∏è –ë–æ—ó</button>
          <button class="quick-btn" style="background: #dc3545;" onclick="clearAllData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ</button>
        </div>

        <div id="playerData" class="data-display">
          <h4>üë• –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≥—Ä–∞–≤—Ü—ñ–≤</h4>
          <div id="playerList" class="player-list">
            <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ" –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</p>
          </div>
        </div>

        <div id="battleData" class="data-display">
          <h4>‚öîÔ∏è –Ü—Å—Ç–æ—Ä—ñ—è –±–æ—ó–≤</h4>
          <div id="battleList" class="battle-list">
            <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ" –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</p>
          </div>
        </div>

        <div class="data-display">
          <h4>üõ†Ô∏è –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¥–∞–Ω–∏–º–∏</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
            <input type="text" id="battleIdToDelete" placeholder="ID –±–æ—é –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è" style="margin: 0;">
            <button class="quick-btn" style="background: #ffc107; color: #000;" onclick="deleteBattle()">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –±—ñ–π</button>
          </div>
          <div class="info">
            <strong>–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è:</strong> –í–∏–¥–∞–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–µ. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –≤–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –¥–∞–Ω—ñ.
          </div>
        </div>
      </div>

      <div id="sendTab" class="tab-content">
        <h3>–í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö</h3>
        
        <div class="quick-actions">
          <button class="quick-btn" onclick="generateTestData()">üé≤ –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ç–µ—Å—Ç–æ–≤—ñ –¥–∞–Ω—ñ</button>
          <button class="quick-btn" onclick="sendTestBattle()">‚öîÔ∏è –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ç–µ—Å—Ç–æ–≤–∏–π –±—ñ–π</button>
          <button class="quick-btn" onclick="addTestPlayer()">üë§ –î–æ–¥–∞—Ç–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≥—Ä–∞–≤—Ü—è</button>
        </div>

        <label>JSON –¥–∞–Ω—ñ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏:</label>
        <textarea id="jsonData" placeholder="–î–∞–Ω—ñ –±—É–¥—É—Ç—å –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∞–±–æ –≤–≤–µ–¥—ñ—Ç—å –≤–ª–∞—Å–Ω—ñ">{}</textarea>
        
        <button onclick="sendData()">üì§ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –¥–∞–Ω—ñ</button>
      </div>
    </div>

    <div class="section">
      <h3>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
      <div class="info">
        <strong>URL:</strong> <span id="requestUrl">-</span><br>
        <strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="responseStatus">-</span><br>
        <strong>–ß–∞—Å –∑–∞–ø–∏—Ç—É:</strong> <span id="requestTime">-</span>
      </div>
      <div id="output" class="output">–í–∏–±–µ—Ä—ñ—Ç—å –¥—ñ—é –≤–∏—â–µ –¥–ª—è –ø–æ—á–∞—Ç–∫—É —Ä–æ–±–æ—Ç–∏ –∑ API</div>
    </div>
  </div>

  <script>
    const BASE_URL = "https://node-websocket-758468a49fee.herokuapp.com";
    let lastData = null;

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      
      document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
    }

    async function makeRequest(method, endpoint, body = null, showInOutput = true) {
      const apiKey = document.getElementById('apiKey').value;
      const playerId = document.getElementById('playerId').value;
      
      const url = `${BASE_URL}/api/battle-stats${endpoint}`;
      const startTime = Date.now();
      
      if (showInOutput) {
        document.getElementById('requestUrl').textContent = url;
        document.getElementById('responseStatus').textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
        document.getElementById('output').textContent = 'üîÑ –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∑–∞–ø–∏—Ç...';
        document.getElementById('output').className = 'output';
      }

      try {
        const headers = {
          'Content-Type': 'application/json',
          'X-API-Key': apiKey
        };

        if (playerId) {
          headers['X-Player-ID'] = playerId;
        }

        const options = { method, headers };
        if (body) {
          options.body = typeof body === 'string' ? body : JSON.stringify(body);
        }

        const response = await fetch(url, options);
        const responseText = await response.text();
        const endTime = Date.now();
        
        let jsonResponse;
        try {
          jsonResponse = JSON.parse(responseText);
        } catch {
          jsonResponse = { rawResponse: responseText };
        }

        if (showInOutput) {
          document.getElementById('responseStatus').textContent = `${response.status} ${response.statusText}`;
          document.getElementById('requestTime').textContent = `${endTime - startTime}ms`;
          document.getElementById('output').textContent = JSON.stringify(jsonResponse, null, 2);
          document.getElementById('output').className = response.ok ? 'output success' : 'output error';
        }

        return { success: response.ok, status: response.status, data: jsonResponse };

      } catch (error) {
        if (showInOutput) {
          document.getElementById('responseStatus').textContent = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ';
          document.getElementById('output').textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
          document.getElementById('output').className = 'output error';
        }
        return { success: false, error: error.message };
      }
    }

    async function quickRequest(type) {
      switch(type) {
        case 'health':
          await makeRequest('GET', '/health');
          break;
        case 'stats':
          const result = await makeRequest('GET', '/stats?limit=0');
          if (result.success) {
            lastData = result.data;
          }
          break;
        case 'stats-paginated':
          await makeRequest('GET', '/stats?page=1&limit=5');
          break;
        case 'other-players':
          await makeRequest('GET', '/other-players');
          break;
      }
    }

    async function sendCustomRequest() {
      const method = document.getElementById('method').value;
      const endpoint = document.getElementById('endpoint').value;
      await makeRequest(method, endpoint);
    }

    async function loadAllData() {
      const result = await makeRequest('GET', '/stats?limit=0', null, false);
      if (result.success) {
        lastData = result.data;
        updateDataDisplay();
        document.getElementById('output').textContent = '‚úÖ –î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ';
        document.getElementById('output').className = 'output success';
      }
    }

    async function loadPlayerInfo() {
      if (lastData && lastData.PlayerInfo) {
        displayPlayers(lastData.PlayerInfo);
      } else {
        await loadAllData();
      }
    }

    async function loadBattles() {
      if (lastData && lastData.BattleStats) {
        displayBattles(lastData.BattleStats);
      } else {
        await loadAllData();
      }
    }

    function updateDataDisplay() {
      if (!lastData) return;
      
      if (lastData.PlayerInfo) {
        displayPlayers(lastData.PlayerInfo);
      }
      
      if (lastData.BattleStats) {
        displayBattles(lastData.BattleStats);
      }
    }

    function displayPlayers(playerInfo) {
      const playerList = document.getElementById('playerList');
      const players = Object.entries(playerInfo);
      
      if (players.length === 0) {
        playerList.innerHTML = '<p>–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ –≥—Ä–∞–≤—Ü—ñ–≤</p>';
        return;
      }

      playerList.innerHTML = players.map(([id, name]) => `
        <div class="item">
          <strong>ID:</strong> ${id}<br>
          <strong>–Ü–º'—è:</strong> ${name}
        </div>
      `).join('');
    }

    function displayBattles(battleStats) {
      const battleList = document.getElementById('battleList');
      const battles = Object.entries(battleStats);
      
      if (battles.length === 0) {
        battleList.innerHTML = '<p>–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ –±–æ—ó</p>';
        return;
      }

      battleList.innerHTML = battles.map(([arenaId, battle]) => {
        const playersCount = Object.keys(battle.players || {}).length;
        const winText = battle.win === 1 ? 'üü¢ –ü–µ—Ä–µ–º–æ–≥–∞' : battle.win === 0 ? 'üî¥ –ü–æ—Ä–∞–∑–∫–∞' : '‚ö™ –ù—ñ—á–∏—è';
        const date = new Date(battle.startTime).toLocaleString('uk-UA');
        
        return `
          <div class="item" style="position: relative;">
            <button onclick="deleteSingleBattle('${arenaId}')" 
                    style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer; font-size: 12px;">
              ‚úï
            </button>
            <strong>–ê—Ä–µ–Ω–∞:</strong> ${arenaId}<br>
            <strong>–ö–∞—Ä—Ç–∞:</strong> ${battle.mapName}<br>
            <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> ${winText}<br>
            <strong>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:</strong> ${Math.floor(battle.duration / 60)}:${String(battle.duration % 60).padStart(2, '0')}<br>
            <strong>–ì—Ä–∞–≤—Ü—ñ–≤:</strong> ${playersCount}<br>
            <strong>–î–∞—Ç–∞:</strong> ${date}
          </div>
        `;
      }).join('');
    }

    function generateTestData() {
      const arenaId = Date.now();
      const playerId = document.getElementById('playerId').value || '123456789';
      
      const testData = {
        "BattleStats": {
          [arenaId]: {
            "startTime": Date.now(),
            "duration": Math.floor(Math.random() * 600) + 180,
            "win": Math.floor(Math.random() * 3) - 1,
            "mapName": "–¢–µ—Å—Ç–æ–≤–∞ –∫–∞—Ä—Ç–∞ " + Math.floor(Math.random() * 10),
            "players": {
              [playerId]: {
                "name": "–¢–µ—Å—Ç–æ–≤–∏–π –ì—Ä–∞–≤–µ—Ü—å",
                "damage": Math.floor(Math.random() * 3000) + 500,
                "kills": Math.floor(Math.random() * 5),
                "points": Math.floor(Math.random() * 2000) + 500,
                "vehicle": "T-34-85"
              }
            }
          }
        },
        "PlayerInfo": {
          [playerId]: "–¢–µ—Å—Ç–æ–≤–∏–π –ì—Ä–∞–≤–µ—Ü—å"
        }
      };

      document.getElementById('jsonData').value = JSON.stringify(testData, null, 2);
    }

    async function sendTestBattle() {
      generateTestData();
      await sendData();
    }

    async function addTestPlayer() {
      const playerId = prompt('–í–≤–µ–¥—ñ—Ç—å ID –≥—Ä–∞–≤—Ü—è:') || Date.now().toString();
      const playerName = prompt('–í–≤–µ–¥—ñ—Ç—å —ñ–º\'—è –≥—Ä–∞–≤—Ü—è:') || '–ù–æ–≤–∏–π –ì—Ä–∞–≤–µ—Ü—å';
      
      const testData = {
        "PlayerInfo": {
          [playerId]: playerName
        }
      };

      document.getElementById('jsonData').value = JSON.stringify(testData, null, 2);
      await sendData();
    }

    async function sendData() {
      const jsonData = document.getElementById('jsonData').value;
      
      try {
        JSON.parse(jsonData);
        await makeRequest('POST', '/update-stats', jsonData);
      } catch (error) {
        document.getElementById('output').textContent = `‚ùå –ù–µ–≤–∞–ª—ñ–¥–Ω–∏–π JSON: ${error.message}`;
        document.getElementById('output').className = 'output error';
      }
    }

    async function clearAllData() {
      if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –í–°–Ü –¥–∞–Ω—ñ –¥–ª—è –≤–∞—à–æ–≥–æ API –∫–ª—é—á–∞? –¶—è –¥—ñ—è –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–∞!')) {
        return;
      }

      const result = await makeRequest('DELETE', '/clear');
      if (result.success) {
        lastData = { BattleStats: {}, PlayerInfo: {} };
        updateDataDisplay();
        document.getElementById('output').textContent = '‚úÖ –í—Å—ñ –¥–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ';
        document.getElementById('output').className = 'output success';
      }
    }

    async function deleteBattle() {
      const battleId = document.getElementById('battleIdToDelete').value.trim();
      
      if (!battleId) {
        alert('–í–≤–µ–¥—ñ—Ç—å ID –±–æ—é –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è');
        return;
      }

      if (!confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –±—ñ–π ${battleId}?`)) {
        return;
      }

      const result = await makeRequest('DELETE', `/battle/${encodeURIComponent(battleId)}`);
      if (result.success) {
        document.getElementById('battleIdToDelete').value = '';
        await loadAllData();
        document.getElementById('output').textContent = `‚úÖ –ë—ñ–π ${battleId} —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ`;
        document.getElementById('output').className = 'output success';
      }
    }

    async function deleteSingleBattle(battleId) {
      if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –±—ñ–π ${battleId}?`)) {
        return;
      }

      const result = await makeRequest('DELETE', `/battle/${encodeURIComponent(battleId)}`, null, false);
      if (result.success) {
        await loadAllData();
        document.getElementById('output').textContent = `‚úÖ –ë—ñ–π ${battleId} –≤–∏–¥–∞–ª–µ–Ω–æ`;
        document.getElementById('output').className = 'output success';
      } else {
        document.getElementById('output').textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –±–æ—é ${battleId}`;
        document.getElementById('output').className = 'output error';
      }
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    window.addEventListener('load', () => {
      loadAllData();
    });
  </script>
</body>
</html>
